.isx-init:
  image:
    name: hashicorp/terraform:1.12
    entrypoint: [""]
  before_script:
    - cd _isx
    - terraform init

isx-stg:
  extends: .isx-init
  script:
    - terraform plan -var="ENV=stg" -var="TEST_EMAIL=${TEST_EMAIL}"
      -var="AWS_ACCESS_KEY=${AWS_ACCESS_KEY}" -var="AWS_SECRET_KEY=${AWS_SECRET_KEY}"
    - terraform apply -auto-approve -var="ENV=stg" -var "TEST_EMAIL=${TEST_EMAIL}"
      -var="AWS_ACCESS_KEY=${AWS_ACCESS_KEY}" -var="AWS_SECRET_KEY=${AWS_SECRET_KEY}"

isx-prod:
  extends: .isx-init
  script:
    - terraform plan -var="ENV=prod" -var="AWS_ACCESS_KEY=${AWS_ACCESS_KEY}"
      -var="AWS_SECRET_KEY=${AWS_SECRET_KEY}"
    - terraform apply -auto-approve -var="ENV=prod" -var="AWS_ACCESS_KEY=${AWS_ACCESS_KEY}"
      -var="AWS_SECRET_KEY=${AWS_SECRET_KEY}"

shell-build:
  image: node:22-alpine
  artifacts:
    paths:
      - shell/dist
  script:
    - cd shell
    - npm ci
    - npm run build

shell-stg:
  image:
    name: amazon/aws-cli:2.27.33
    entrypoint: [""]
  needs:
    - shell-build
    - isx-stg
  dependencies:
    - shell-build
  script:
    - aws s3 sync --delete shell/dist s3://stg-mytasks-shell
